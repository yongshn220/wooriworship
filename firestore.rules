rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidName(name) {
      return name is string
        && name.size() >= 2
        && name.size() <= 50;
    }

    // Users Collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();

      // Users can only write to their own document
      allow create: if isOwner(userId)
        && (!('email_verified' in request.resource.data) || request.resource.data.email_verified == false)
        && (!('name' in request.resource.data) || isValidName(request.resource.data.name));

      allow update: if isOwner(userId)
        // Prevent client-side modification of email_verified field
        && (!('email_verified' in request.resource.data)
            || request.resource.data.email_verified == resource.data.email_verified)
        // Validate name field if present
        && (!('name' in request.resource.data) || isValidName(request.resource.data.name))
        // Prevent email changes (Firebase Auth manages this)
        && (!('email' in request.resource.data)
            || request.resource.data.email == resource.data.email);

      allow delete: if isOwner(userId);

      // User config subcollection (e.g., account_setting)
      match /config/{configId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Account Settings (if this is separate from users/config)
    match /account_settings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Global Invitation Query (Collection Group Support)
    // Keep permissive for now - invitations have email-based access control
    match /{path=**}/invitations/{invitationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      // TODO: Add more granular permissions based on sender/recipient email
    }

    // Teams and Nested Subcollections
    match /teams/{teamId} {
      // For teams, we allow read for authenticated users
      // Write access should ideally be restricted to team members
      // However, checking membership requires accessing the members subcollection
      // which is complex in Firestore rules. Consider adding a 'members' array field
      // to the team document for easier permission checks.
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      // TODO: Implement proper team membership check
      // Example: allow write: if isAuthenticated() && request.auth.uid in resource.data.memberIds;

      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
        // TODO: Only team admins should be able to modify members
      }

      match /invitations/{invitationId} {
        allow read, write: if isAuthenticated();
      }

      match /notices/{noticeId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
        // TODO: Only team members should write
      }

      match /song_tags/{tagId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      match /service_tags/{tagId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      match /worships/{worshipId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      match /songs/{songId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();

        match /sheets/{sheetId} {
            allow read, write: if isAuthenticated();

            // Annotations subcollection - user-specific pen annotations on sheet music
            // Document ID format: {userId}_page_{pageIndex}
            // Security: Each user can only query/write their own docs (by doc ID containing their uid)
            match /annotations/{annotationId} {
                allow read, write: if isAuthenticated();
            }
        }
        match /comments/{commentId} {
            allow read, write: if isAuthenticated();
        }
      }

      match /praise_team_roles/{roleId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      // Unified Service (V3)
      match /services/{serviceId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();

        match /setlists/{id} { allow read, write: if isAuthenticated(); }
        match /flows/{id} { allow read, write: if isAuthenticated(); }
        match /praise_team/{id} { allow read, write: if isAuthenticated(); }
      }

      // Service Flow Templates
      match /service_flow_templates/{templateId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      // Praise Team Templates
      match /praise_team_templates/{templateId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      match /service_config/{configId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      match /config/{configId} { // e.g. tag_stats
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      // Todos
      match /todos/{todoId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
  }
}
